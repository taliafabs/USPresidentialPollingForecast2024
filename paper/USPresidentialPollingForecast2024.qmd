---
title: "My title"
subtitle: "Forecasting the 2024 U.S. Presidential Election using Poll of Polls Methodology"
author: 
  - Talia Fabregas
  - Fatimah Yunusa
  - Aliza Mithwani
thanks: "The code and data used to perform this presidential election forecast can be found at: [https://github.com/taliafabs/USPresidentialPollingForecast2024.git](https://github.com/taliafabs/USPresidentialPollingForecast2024.git)."
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false
#| echo: false

library(tidyverse)
library(janitor)
library(ggplot2)
library(scales)
library(rstanarm)

setwd("/Users/talia/USPresidentialPollingForecast2024")
analysis_data <- arrow::read_parquet("data/02-analysis_data/analysis_data.parquet")
harris_analysis_data <- arrow::read_parquet("data/02-analysis_data/harris-analysis_data.parquet")
trump_analysis_data <- arrow::read_parquet("data/02-analysis_data/trump-analysis_data.parquet")
```


# Introduction

<!-- Overview paragraph -->
The U.S. Presidential Election will take place on Tuesday November 5th. Vice President Kamala Harris and former President Donald Trump will vie to become the 47th President of the United States. Vice President Kamala Harris became the Democratic nominee after 82-year-old President Joe Biden made a historic and unprecedented decision to end his re-election campaign on July 21, 2024. She secured enough delegates to win the Democratic nomination on 
Vice President Kamala Harris and Former President Donald Trump ... President Joe Biden made the unprecedented decision to end his re-election campaign on July 21, 2024 and immediately endorsed Vice President Kamala Harris. She became the presumptive Democratic presidential nominee the same day and secured enough delegates to win the nomination on July 28.

This study only considers polling data from after President Joe Biden ended his re-election campaign and Vice President Kamala Harris became the presumptive Democratic nominee for President. Polls conducted before July 21, 2024 were not considered because they include President Joe Biden, who is no longer running for President, as the Democratic nominee. 

Estimand paragraph

Results paragraph

Why it matters paragraph

The remainder of this paper is structured as follows. @sec-data contains 


# Data {#sec-data}

## Overview
This presidential election forecast was performed using the statistical programming language R [@citeR] and Presidential general election polling data from FiveThirtyEight [@fivethirtyeight]. Data cutoff October 29, 2024. No resources or articles from after this date were used or considered in any way. 

## Measurement
	
Some paragraphs about how we go from a phenomena in the world to an entry in the dataset.

## Outcome variables

Add graphs, tables and text. Use sub-sub-headings for each outcome variable or update the subheading to be singular.

### National and swing state polling averages over time
This takes into account date and state.
```{r}
#| label: fig-nationalavg
#| fig-cap: National Polling Averages since May 2024
#| echo: false
#| warning: false
#| message: false

national <- analysis_data |>
  filter(state=="National")

ggplot(national, aes(x = end_date, y = pct, color = party)) +
  stat_summary(geom = "line", fun = mean) +      # Plot the mean line for polling percentages
  geom_point(size = 1, alpha = 0.2) +            # Add points for each individual poll
  scale_color_manual(values = c("DEM" = "blue", "REP" = "red")) +
  geom_vline(xintercept = as.Date("2024-07-21"), linetype = "dashed", color = "darkgray") +
  labs(title = "National Polling Average by Party (DEM vs REP)",
       x = "",
       y = "",
       color = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(limits = c(0, 60), labels = scales::percent_format(scale = 1)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %e")  # Use scale_x_date for date variables
```

Since President Biden ended his re-election campaign and Vice President Harris became the Democratic Presidential nominee, the polls have shown a dead heat between Vice President Harris and former President Trump.

```{r}
#| label: fig-sevenbattlegrounds
#| fig-cap: seven battleground states
#| echo: false
#| warning: false
#| message: false
sevenbattlegrounds <- analysis_data |>
  filter(state=="Wisconsin" | state == "Michigan" | state == "Pennsylvania" |
           state == "Nevada" | state == "Arizona" | state == "Georgia" | 
           state == "North Carolina" | state == "Nebraska CD-2")

ggplot(sevenbattlegrounds, aes(x = end_date, y = pct, color = party)) +
  stat_summary(geom = "line", fun = mean) +      # Plot the mean line for polling percentages
  geom_point(size = 1, alpha = 0.15) +            # Add points for each individual poll
  scale_color_manual(values = c("DEM" = "blue", "REP" = "red")) +
  geom_vline(xintercept = as.Date("2024-07-21"), linetype = "dashed", color = "darkgray") +
  labs(title = "swing states",
       x = "Date",
       y = "Average Polling %",
       color = "Party") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(limits = c(0, 60), labels = scales::percent_format(scale = 1)) +
  scale_x_date(date_breaks = "2 month", date_labels = "%b %e") +
  facet_wrap(~state)
```
```{r}
#| label: fig-nationalavg2
#| fig-cap: National Polling Averages since May 2024
#| echo: false
#| warning: false
#| message: false

national2 <- analysis_data |>
  filter(state=="National",
         (candidate_name == "Kamala Harris" | candidate_name == "Donald Trump"),
         end_date >= as.Date("2024-07-21")
         )

ggplot(national2, aes(x = end_date, y = pct, color = candidate_name)) +
  stat_summary(geom = "line", fun = mean) +      # Plot the mean line for polling percentages
  geom_point(size = 1, alpha = 0.25) +            # Add points for each individual poll
  scale_color_manual(values = c("Kamala Harris" = "blue", "Donald Trump" = "red")) +
  # geom_vline(xintercept = as.Date("2024-07-21"), linetype = "dashed", color = "darkgray") +
  labs(title = "National Polling Average Harris v Trump",
       x = "",
       y = "",
       color = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(limits = c(0, 60), labels = scales::percent_format(scale = 1)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %e")
```

```{r}
#| label: fig-sevenbattlegroundskamala
#| fig-cap: seven battleground states with harris
#| echo: false
#| warning: false
#| message: false
#| 
sevenbattlegrounds2 <- analysis_data |>
  filter((state=="Wisconsin" | state == "Michigan" | state == "Pennsylvania" |
           state == "Nevada" | state == "Arizona" | state == "Georgia" | 
           state == "North Carolina" | state == "Nebraska CD-2"),
         (candidate_name == "Kamala Harris" | candidate_name == "Donald Trump"),
         end_date >= as.Date("2024-07-21"))

ggplot(sevenbattlegrounds2, aes(x = end_date, y = pct, color = candidate_name)) +
  stat_summary(geom = "line", fun = mean) +      # Plot the mean line for polling percentages
  geom_point(size = 1, alpha = 0.15) +            # Add points for each individual poll
  scale_color_manual(values = c("Kamala Harris" = "blue", "Donald Trump" = "red")) +
  labs(title = "swing states",
       x = "",
       y = "",
       color = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(limits = c(0, 60), labels = scales::percent_format(scale = 1)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %e") +
  facet_wrap(~state)
```

### Pollster
Talk more about it.

```{r}
#| label: fig-pollsters1
#| fig-cap: Pollsters caption
#| echo: false
#| warning: false
#| message: false

ggplot(national2, aes(x = end_date, y = pct, color = candidate_name)) +
  stat_summary(geom = "line", fun = mean) +      # Plot the mean line for polling percentages
  geom_point(size = 1, alpha = 0.25) +            # Add points for each individual poll
  scale_color_manual(values = c("Kamala Harris" = "blue", "Donald Trump" = "red")) +
  # geom_vline(xintercept = as.Date("2024-07-21"), linetype = "dashed", color = "darkgray") +
  labs(title = "National Polling Average Harris v Trump by Pollster",
       x = "",
       y = "",
       color = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(limits = c(0, 60), labels = scales::percent_format(scale = 1)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %e") +
  facet_wrap(~pollster)
```
And also planes (@fig-planes). (You can change the height and width, but don't worry about doing that until you have finished every other aspect of the paper - Quarto will try to make it look nice and the defaults usually work well once you have enough text.)

```{r}
#| label: fig-planes
#| fig-cap: Relationship between wing length and width
#| echo: false
#| warning: false
#| message: false

# analysis_data <- read_csv(here::here("data/02-analysis_data/analysis_data.csv"))
# 
# analysis_data |> 
#   ggplot(aes(x = width, y = length)) +
#   geom_point(alpha = 0.8) +
#   theme_minimal() +
#   labs(x = "Wing width (mm)",
#        y = "Wing length (mm)")
```


## Predictor variables

Add graphs, tables and text.

Use sub-sub-headings for each outcome variable and feel free to combine a few into one if they go together naturally.








# Model

The goal of our modelling strategy is twofold. 

Here we briefly describe the Bayesian analysis model used to investigate... Background details and diagnostics are included in [Appendix -@sec-model-details].

## Model set-up

Define $y_i$ as the number of seconds that the plane remained aloft. Then $\beta_i$ is the wing width and $\gamma_i$ is the wing length, both measured in millimeters.  

\begin{align} 
y_i|\mu_i, \sigma &\sim \mbox{Normal}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_i + \gamma_i\\
\alpha &\sim \mbox{Normal}(0, 2.5) \\
\beta &\sim \mbox{Normal}(0, 2.5) \\
\gamma &\sim \mbox{Normal}(0, 2.5) \\
\sigma &\sim \mbox{Exponential}(1)
\end{align}

We run the model in R [@citeR] using the `rstanarm` package of @rstanarm. We use the default priors from `rstanarm`.


### Model justification

We expect a positive relationship between the size of the wings and time spent aloft. In particular...

We can use maths by including latex between dollar signs, for instance $\theta$.


# Results

Our results are summarized in @tbl-modelresults.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

library(rstanarm)

harris_model <-
  readRDS(file = here::here("models/harris_model.rds"))

trump_model <- 
  readRDS(file = here::here("models/trump_model.rds"))
```

```{r}
#| echo: false
#| eval: true
#| label: tbl-modelresults
#| tbl-cap: "Explanatory models of support for Harris and Trump based on ..."
#| warning: false

modelsummary::modelsummary(
  list(
    "Harris" = harris_model,
    "Trump" = trump_model
  ),
  statistic = "mad",
  fmt = 2
)
```

## Popular Vote Results
```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

library(splines)

# harris_new_data <- data.frame(
#   end_date_num = seq(
#     min(harris_analysis_data$end_date_num, na.rm = TRUE),  # Ensure NAs are handled
#     max(harris_analysis_data$end_date_num, na.rm = TRUE),
#     length.out = 100
#   ),
#   state = factor(rep(levels(harris_analysis_data$state)[1], 100), levels = levels(harris_analysis_data$state)),  # Use a valid state
#   pollster = factor(rep(levels(harris_analysis_data$pollster)[1], 100), levels = levels(harris_analysis_data$pollster))  # Use a valid pollster
# )
harris_analysis_data$state <- factor(harris_analysis_data$state)
harris_analysis_data$pollster <- factor(harris_analysis_data$pollster)

harris_new_data <- data.frame(
  end_date_num = seq(
    min(harris_analysis_data$end_date_num),
    max(harris_analysis_data$end_date_num),
    length.out = 100
  ),
  pollster = factor("Siena/NYT", levels = levels(harris_analysis_data$pollster)),
  state = factor("National", levels = levels(harris_analysis_data$state))
)

# harris_posterior_preds_national <- posterior_predict(harris_model,
#                                      newdata = harris_new_data
#                                      )
# Calculate a pred_summary for Harris at the national level across all pollsters
# Define the unique levels of pollster

pollster_levels <- levels(harris_analysis_data$pollster)

# Initialize a list to store predictions for each pollster
all_pollster_preds <- list()

# Loop over each pollster to generate predictions
for (p in pollster_levels) {
  # Create new data for each pollster
  harris_new_data <- data.frame(
    end_date_num = seq(
      min(harris_analysis_data$end_date_num),
      max(harris_analysis_data$end_date_num),
      length.out = 100
    ),
    pollster = factor(p, levels = pollster_levels),
    state = factor("National", levels = levels(harris_analysis_data$state))
  )
  
  # Generate posterior predictions for this pollster
  preds <- posterior_predict(harris_model, newdata = harris_new_data)
  all_pollster_preds[[p]] <- preds  # Store in list
}

# Combine predictions across all pollsters
# Convert list of matrices into a 3D array: [iterations, predictions, pollster]
all_pollster_preds_array <- simplify2array(all_pollster_preds)

# Calculate summary statistics across pollsters
# Averaging predictions across pollsters at each iteration
pred_mean <- apply(all_pollster_preds_array, c(1, 2), mean)
pred_lower <- apply(all_pollster_preds_array, 2, quantile, probs = 0.025)
pred_upper <- apply(all_pollster_preds_array, 2, quantile, probs = 0.975)

# Combine these into a summary data frame
harris_pred_summary <- harris_new_data %>%
  mutate(
    pred_mean = colMeans(pred_mean),
    pred_lower = pred_lower,
    pred_upper = pred_upper
  )

ggplot(harris_analysis_data, aes(x = end_date_num, y = pct, color = pollster)) +
  geom_point() +
  geom_line(
    data = harris_pred_summary,
    aes(x = end_date_num, y = pred_mean),
    color = "blue",
    inherit.aes = FALSE
  ) +
  geom_ribbon(
    data = harris_pred_summary,
    aes(x = end_date_num, ymin = pred_lower, ymax = pred_upper),
    alpha = 0.2,
    inherit.aes = FALSE
  ) +
  labs(
    x = "Days since earliest poll",
    y = "Percentage",
    title = "Poll Percentage over Time with Spline Fit"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) 
```

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

library(splines)
trump_analysis_data$state <- factor(trump_analysis_data$state)
trump_analysis_data$pollster <- factor(trump_analysis_data$pollster)

# Define unique pollster levels
pollster_levels <- levels(trump_analysis_data$pollster)

# Initialize list to store predictions for each pollster
all_pollster_preds <- list()

# Loop over each pollster to generate predictions
for (p in pollster_levels) {
  # Create trump_new_data for each pollster
  trump_new_data <- data.frame(
    end_date_num = seq(
      min(trump_analysis_data$end_date_num),
      max(trump_analysis_data$end_date_num),
      length.out = 100
    ),
    pollster = factor(p, levels = pollster_levels),
    state = factor("National", levels = levels(trump_analysis_data$state))
  )
  
  # Generate posterior predictions for this pollster
  preds <- posterior_predict(trump_model, newdata = trump_new_data)
  all_pollster_preds[[p]] <- preds  # Store in list
}

# Combine predictions across all pollsters
# Convert list of matrices into a 3D array: [iterations, predictions, pollster]
all_pollster_preds_array <- simplify2array(all_pollster_preds)

# Calculate summary statistics across pollsters
# Averaging predictions across pollsters at each iteration
pred_mean <- apply(all_pollster_preds_array, c(1, 2), mean)
pred_lower <- apply(all_pollster_preds_array, 2, quantile, probs = 0.025)
pred_upper <- apply(all_pollster_preds_array, 2, quantile, probs = 0.975)

# Combine these into a summary data frame
trump_pred_summary <- trump_new_data %>%
  mutate(
    pred_mean = colMeans(pred_mean),
    pred_lower = pred_lower,
    pred_upper = pred_upper
  )

# Plot using the aggregated predictions
ggplot(trump_analysis_data, aes(x = end_date_num, y = pct, color = pollster)) +
  geom_point() +
  geom_line(
    data = trump_pred_summary,
    aes(x = end_date_num, y = pred_mean),
    color = "red",
    inherit.aes = FALSE
  ) +
  geom_ribbon(
    data = trump_pred_summary,
    aes(x = end_date_num, ymin = pred_lower, ymax = pred_upper),
    alpha = 0.2,
    inherit.aes = FALSE
  ) +
  labs(
    x = "Days since earliest poll",
    y = "",
    title = "Poll Percentage over Time with Spline Fit (Trump)"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) 



# trump_new_data <- data.frame(
#   end_date_num = seq(
#     min(trump_analysis_data$end_date_num),
#     max(trump_analysis_data$end_date_num),
#     length.out = 100
#   ),
#   pollster = factor("YouGov", levels = levels(trump_analysis_data$pollster)),
#   state = factor("National", levels = levels(trump_analysis_data$state))
# )
# 
# trump_posterior_preds_national <- posterior_predict(trump_model,
#                                      newdata = trump_new_data
#                                      )
# 
# pred_summary <- trump_new_data |>
#   mutate(
#     pred_mean = colMeans(trump_posterior_preds_national),
#     pred_lower = apply(trump_posterior_preds_national, 2, quantile, probs = 0.025),
#     pred_upper = apply(trump_posterior_preds_national, 2, quantile, probs = 0.975)
#   )

# ggplot(trump_analysis_data, aes(x = end_date_num, y = pct, color = pollster)) +
#   geom_point() +
#   geom_line(
#     data = trump_pred_summary,
#     aes(x = end_date_num, y = pred_mean),
#     color = "red",
#     inherit.aes = FALSE
#   ) +
#   geom_ribbon(
#     data = pred_summary,
#     aes(x = end_date_num, ymin = pred_lower, ymax = pred_upper),
#     alpha = 0.2,
#     inherit.aes = FALSE
#   ) +
#   labs(
#     x = "Days since earliest poll",
#     y = "Percentage",
#     title = "Poll Percentage over Time with Spline Fit (Trump)"
#   ) +
#   theme_minimal()
```
```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

# Add a candidate column with full names to each summary data frame
harris_pred_summary <- harris_pred_summary %>%
  mutate(candidate = "Kamala Harris")

trump_pred_summary <- trump_pred_summary %>%
  mutate(candidate = "Donald Trump")

# Combine the data frames
combined_pred_summary <- bind_rows(harris_pred_summary, trump_pred_summary)

# Plot the combined data with both candidates' lines and ribbons
ggplot() +
  # Plot the original data points for Harris
  geom_point(data = harris_analysis_data, aes(x = end_date_num, y = pct, color = pollster), alpha = 0.6) +
  # Plot the original data points for Trump
  geom_point(data = trump_analysis_data, aes(x = end_date_num, y = pct, color = pollster), alpha = 0.6) +
  # Plot the prediction line for Kamala Harris
  geom_line(
    data = combined_pred_summary %>% filter(candidate == "Kamala Harris"),
    aes(x = end_date_num, y = pred_mean, color = candidate),
    inherit.aes = FALSE
  ) +
  # Plot the prediction line for Donald Trump
  geom_line(
    data = combined_pred_summary %>% filter(candidate == "Donald Trump"),
    aes(x = end_date_num, y = pred_mean, color = candidate),
    inherit.aes = FALSE
  ) +
  # # Plot the prediction ribbon for Kamala Harris
  # geom_ribbon(
  #   data = combined_pred_summary %>% filter(candidate == "Kamala Harris"),
  #   aes(x = end_date_num, ymin = pred_lower, ymax = pred_upper, fill = candidate),
  #   alpha = 0.1,
  #   inherit.aes = FALSE
  # ) +
  # # Plot the prediction ribbon for Donald Trump
  # geom_ribbon(
  #   data = combined_pred_summary %>% filter(candidate == "Donald Trump"),
  #   aes(x = end_date_num, ymin = pred_lower, ymax = pred_upper, fill = candidate),
  #   alpha = 0.1,
  #   inherit.aes = FALSE
  # ) +
  labs(
    x = "Days since earliest poll",
    y = "Percentage",
    title = "Poll Percentage over Time with Spline Fit (Kamala Harris vs Donald Trump)"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_color_manual(values = c("Kamala Harris" = "blue", "Donald Trump" = "red")) +
  scale_fill_manual(values = c("Kamala Harris" = "blue", "Donald Trump" = "red")) +
  guides(color = guide_legend(title = "Candidate"), fill = guide_legend(title = "Candidate"))
```

## State-Level Results for the Seven Battleground States
```{r}
```
# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

Please don't use these as sub-heading labels - change them to be what your point actually is.

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}

# Idealized methodology
## Idealized survey

# Pollster methodology overview and evaluation

# Additional data details

## Polling averages from before President Joe Biden ended his re-election campaign {#sec-Biden}

# Model details {#sec-model-details}

## Posterior predictive check

In @fig-ppcheckandposteriorvsprior-1 we implement a posterior predictive check. This shows...

In @fig-ppcheckandposteriorvsprior-2 we compare the posterior with the prior. This shows... 

```{r}
#| eval: true
#| echo: false
#| message: false
#| warning: false
#| label: fig-ppcheckandposteriorvsprior
#| layout-ncol: 2
#| fig-cap: "Examining how the model fits, and is affected by, the data"
#| fig-subcap: ["Posterior prediction check", "Comparing the posterior with the prior"]

# pp_check(first_model) +
#   theme_classic() +
#   theme(legend.position = "bottom")
# 
# posterior_vs_prior(first_model) +
#   theme_minimal() +
#   scale_color_brewer(palette = "Set1") +
#   theme(legend.position = "bottom") +
#   coord_flip()
```

## Diagnostics

@fig-stanareyouokay-1 is a trace plot. It shows... This suggests...

@fig-stanareyouokay-2 is a Rhat plot. It shows... This suggests...

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-stanareyouokay
#| fig-cap: "Checking the convergence of the MCMC algorithm"
#| fig-subcap: ["Trace plot", "Rhat plot"]
#| layout-ncol: 2

# plot(first_model, "trace")
# 
# plot(first_model, "rhat")
```



\newpage


# References